<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>TranslateGemma ç¿»è¯‘æœåŠ¡ v2</title>
    <style>
        :root { --bg: #f5f5f5; --card: #fff; --text: #333; --border: #ddd; --primary: #4a90d9; --success: #52c41a; --warning: #faad14; }
        .dark { --bg: #1a1a2e; --card: #16213e; --text: #eee; --border: #333; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 20px; transition: all 0.3s; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h1 { font-size: 1.5rem; }
        .controls { display: flex; gap: 10px; align-items: center; }
        select, button, input, textarea { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: var(--text); font-size: 14px; }
        button { cursor: pointer; background: var(--primary); color: #fff; border: none; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .main { grid-template-columns: 1fr; } }
        .panel { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .panel h3 { margin-bottom: 15px; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; }
        textarea { width: 100%; height: 200px; resize: vertical; font-size: 16px; line-height: 1.6; }
        .lang-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .lang-row select { flex: 1; }
        .swap-btn { background: var(--card); color: var(--text); border: 1px solid var(--border); padding: 8px 15px; }
        .actions { display: flex; gap: 10px; margin-top: 15px; }
        .actions button { flex: 1; padding: 12px; font-size: 16px; }
        .btn-stream { background: #28a745; }
        .stats { font-size: 12px; color: #888; margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 6px; }
        .stats span { margin-right: 15px; }
        .stats .highlight { color: var(--primary); font-weight: bold; }
        details { margin-top: 15px; }
        summary { cursor: pointer; color: var(--primary); font-size: 14px; }
        .params { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 12px; }
        .param label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
        .param input { width: 100%; }
        .param input[type="range"] { padding: 0; }
        .param .value { font-size: 11px; color: var(--primary); float: right; }
        .gpu-bar { margin-top: 20px; padding: 15px; background: var(--card); border-radius: 8px; }
        .gpu-bar h4 { font-size: 14px; margin-bottom: 10px; }
        .gpu-info { display: flex; gap: 20px; flex-wrap: wrap; font-size: 13px; align-items: center; }
        .gpu-info span { display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot.on { background: var(--success); }
        .dot.off { background: #999; }
        .dot.loading { background: var(--warning); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #loading { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .spinner { border: 3px solid #333; border-top-color: var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .copy-btn { background: transparent; color: var(--text); border: 1px solid var(--border); padding: 4px 10px; font-size: 12px; }
        .progress-bar { height: 4px; background: var(--border); border-radius: 2px; margin: 10px 0; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: var(--primary); transition: width 0.3s; width: 0%; }
        .file-upload { border: 2px dashed var(--border); border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; margin-bottom: 10px; font-size: 13px; }
        .file-upload:hover { border-color: var(--primary); }
        .file-upload.dragover { border-color: var(--primary); background: rgba(74,144,217,0.1); }
        .file-upload input { display: none; }
        .chunk-item { padding: 8px; margin: 4px 0; background: var(--bg); border-left: 3px solid var(--primary); border-radius: 0 4px 4px 0; font-size: 14px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* æ¨¡å‹é€‰æ‹©å™¨æ ·å¼ */
        .model-selector { margin-bottom: 20px; padding: 15px; background: var(--card); border-radius: 8px; }
        .model-selector h4 { font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .model-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .model-card { padding: 12px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .model-card:hover { border-color: var(--primary); }
        .model-card.active { border-color: var(--primary); background: rgba(74,144,217,0.1); }
        .model-card.loading { border-color: var(--warning); }
        .model-card .name { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .model-card .info { font-size: 11px; color: #888; }
        .model-card .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 4px; }
        .badge-size { background: #e3f2fd; color: #1976d2; }
        .badge-quant { background: #fff3e0; color: #f57c00; }
        .badge-quality { background: #e8f5e9; color: #388e3c; }
        .badge-best { background: #fce4ec; color: #c2185b; }
        .dark .badge-size { background: #1565c0; color: #fff; }
        .dark .badge-quant { background: #ef6c00; color: #fff; }
        .dark .badge-quality { background: #2e7d32; color: #fff; }
        .dark .badge-best { background: #ad1457; color: #fff; }
    </style>
</head>
<body class="dark">
    <div class="container">
        <header>
            <h1>ğŸŒ TranslateGemma ç¿»è¯‘æœåŠ¡</h1>
            <div class="controls">
                <button onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
                <a href="/docs" target="_blank"><button type="button">ğŸ“š APIæ–‡æ¡£</button></a>
            </div>
        </header>

        <!-- æ¨¡å‹é€‰æ‹©å™¨ -->
        <div class="model-selector">
            <h4>ğŸ¤– é€‰æ‹©æ¨¡å‹ <span id="model-loading" style="display:none;color:var(--warning);font-size:12px;">åŠ è½½ä¸­...</span></h4>
            <div class="model-grid" id="model-grid"></div>
        </div>

        <div class="main">
            <div class="panel">
                <h3>æºæ–‡æœ¬ <button class="copy-btn" onclick="copyText('source')">å¤åˆ¶</button></h3>
                
                <div class="file-upload" id="dropZone">
                    ğŸ“ æ‹–æ‹½æ–‡æœ¬æ–‡ä»¶æˆ–ç‚¹å‡»ä¸Šä¼ 
                    <input type="file" id="fileInput" accept=".txt,.md,.text">
                </div>
                
                <div class="lang-row">
                    <select id="source-lang"></select>
                    <button class="swap-btn" onclick="swapLang()">â‡„</button>
                    <select id="target-lang"></select>
                </div>
                <textarea id="source" placeholder="è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬..."></textarea>
                
                <details>
                    <summary>âš™ï¸ é«˜çº§å‚æ•°</summary>
                    <div class="params">
                        <div class="param">
                            <label>Chunk Size <span class="value" id="chunk-val">80</span></label>
                            <input type="range" id="chunk_size" min="40" max="150" step="10" value="80" oninput="updateVal('chunk-val', this.value)">
                        </div>
                        <div class="param">
                            <label>Overlap <span class="value" id="overlap-val">10</span></label>
                            <input type="range" id="overlap" min="0" max="30" step="5" value="10" oninput="updateVal('overlap-val', this.value)">
                        </div>
                        <div class="param">
                            <label>Max Tokens <span class="value" id="tokens-val">512</span></label>
                            <input type="range" id="max_tokens" min="256" max="2048" step="128" value="512" oninput="updateVal('tokens-val', this.value)">
                        </div>
                    </div>
                </details>
                
                <div class="actions">
                    <button onclick="doTranslate(false)" id="translate-btn">ğŸš€ ç¿»è¯‘</button>
                    <button onclick="doTranslate(true)" id="stream-btn" class="btn-stream">âš¡ æµå¼</button>
                    <button onclick="clearAll()" style="background:#666;flex:0.5;">æ¸…ç©º</button>
                </div>
            </div>

            <div class="panel">
                <h3>ç¿»è¯‘ç»“æœ <button class="copy-btn" onclick="copyText('result')">å¤åˆ¶</button></h3>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-info" id="progressInfo" style="display:none;font-size:12px;color:#888;margin-bottom:10px;">
                    <span>ğŸ“¦ è¿›åº¦: <span id="progress-current">0</span>/<span id="progress-total">0</span> æ®µ</span>
                    <span style="margin-left:15px;">â±ï¸ å·²ç”¨: <span id="progress-elapsed">0</span>s</span>
                </div>
                <textarea id="result" readonly placeholder="ç¿»è¯‘ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                <div id="streamOutput" style="display:none;max-height:200px;overflow-y:auto;"></div>
                <div class="stats" id="stats" style="display:none;">
                    <span>â±ï¸ è€—æ—¶: <span class="highlight" id="stat-time">-</span></span>
                    <span>ğŸ“ è¾“å…¥: <span id="stat-input">-</span> å­—ç¬¦</span>
                    <span>ğŸ“„ è¾“å‡º: <span id="stat-output">-</span> å­—ç¬¦</span>
                    <span>ğŸ“¦ åˆ†æ®µ: <span id="stat-chunks">-</span></span>
                    <span>ğŸ¤– æ¨¡å‹: <span id="stat-model">-</span></span>
                </div>
            </div>
        </div>

        <div class="gpu-bar">
            <h4>ğŸ–¥ï¸ GPU çŠ¶æ€</h4>
            <div class="gpu-info">
                <span><span class="dot" id="gpu-dot"></span> <span id="gpu-status">æ£€æŸ¥ä¸­...</span></span>
                <span>ğŸ’¾ æ˜¾å­˜: <span id="gpu-mem">-</span></span>
                <span>â° ç©ºé—²: <span id="gpu-idle">-</span></span>
                <span>ğŸ¤– å½“å‰æ¨¡å‹: <span id="gpu-model">-</span></span>
                <button onclick="releaseGPU()" style="padding:4px 10px;font-size:12px;">é‡Šæ”¾æ˜¾å­˜</button>
            </div>
        </div>
    </div>

    <div id="loading"><div class="spinner"></div></div>

    <script>
        const LANGS = {};
        let MODELS = {};
        let currentModel = null;
        let defaultModel = null;
        
        async function init() {
            // åŠ è½½è¯­è¨€åˆ—è¡¨
            try {
                const langs = await fetch('/api/languages').then(r => r.json());
                Object.assign(LANGS, langs);
                
                const srcSel = document.getElementById('source-lang');
                const tgtSel = document.getElementById('target-lang');
                srcSel.innerHTML = '<option value="">è‡ªåŠ¨æ£€æµ‹</option>';
                tgtSel.innerHTML = '';
                
                for (const [code, name] of Object.entries(langs)) {
                    srcSel.innerHTML += `<option value="${code}">${name} (${code})</option>`;
                    tgtSel.innerHTML += `<option value="${code}">${name} (${code})</option>`;
                }
                tgtSel.value = 'zh';
            } catch(e) {
                console.error('Failed to load languages:', e);
            }
            
            // åŠ è½½æ¨¡å‹åˆ—è¡¨
            await loadModels();
            
            updateGPU();
            setInterval(updateGPU, 5000);
            
            if (localStorage.getItem('theme') === 'light') document.body.classList.remove('dark');
            
            // æ–‡ä»¶ä¸Šä¼ 
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            dropZone.onclick = () => fileInput.click();
            dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
            dropZone.ondragleave = () => dropZone.classList.remove('dragover');
            dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); };
            fileInput.onchange = () => handleFile(fileInput.files[0]);
        }
        
        async function loadModels() {
            try {
                const data = await fetch('/api/models').then(r => r.json());
                MODELS = data.models || {};
                // åªæœ‰å½“ GPU å·²åŠ è½½æ¨¡å‹æ—¶æ‰è®¾ç½® currentModelï¼Œå¦åˆ™ä¸º null
                currentModel = data.current;  // ä¸ä½¿ç”¨ default ä½œä¸º fallback
                defaultModel = data.default;
                renderModelGrid();
            } catch(e) {
                console.error('Failed to load models:', e);
            }
        }
        
        function renderModelGrid() {
            const grid = document.getElementById('model-grid');
            grid.innerHTML = '';
            
            for (const [id, info] of Object.entries(MODELS)) {
                const card = document.createElement('div');
                // åªæœ‰çœŸæ­£åŠ è½½çš„æ¨¡å‹æ‰æ˜¾ç¤º active
                card.className = 'model-card' + (currentModel === id ? ' active' : '');
                card.dataset.model = id;
                
                const badges = [];
                // Size badge
                if (info.size) badges.push(`<span class="badge badge-size">${info.size}</span>`);
                // Quantization badge
                if (info.quantization) badges.push(`<span class="badge badge-quant">${info.quantization}</span>`);
                // Quality badge
                if (info.quality) {
                    const qClass = info.quality.includes('Best') ? 'badge-best' : 'badge-quality';
                    badges.push(`<span class="badge ${qClass}">${info.quality}</span>`);
                }
                
                card.innerHTML = `
                    <div class="name">${info.name || id}</div>
                    <div class="info">${badges.join('')}</div>
                    <div class="info" style="margin-top:4px;">${info.description || ''}</div>
                `;
                card.onclick = () => switchModel(id);
                grid.appendChild(card);
            }
        }
        
        async function switchModel(modelId) {
            if (modelId === currentModel) return;
            
            const cards = document.querySelectorAll('.model-card');
            cards.forEach(c => c.classList.remove('active', 'loading'));
            
            const targetCard = document.querySelector(`[data-model="${modelId}"]`);
            targetCard.classList.add('loading');
            document.getElementById('model-loading').style.display = 'inline';
            
            try {
                const res = await fetch('/api/models/switch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({model: modelId})
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    currentModel = modelId;
                    targetCard.classList.remove('loading');
                    targetCard.classList.add('active');
                    updateGPU();
                } else {
                    alert('åˆ‡æ¢å¤±è´¥: ' + (data.error || data.detail));
                    targetCard.classList.remove('loading');
                }
            } catch(e) {
                alert('åˆ‡æ¢å¤±è´¥: ' + e.message);
                targetCard.classList.remove('loading');
            } finally {
                document.getElementById('model-loading').style.display = 'none';
            }
        }
        
        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('source').value = e.target.result;
                document.getElementById('dropZone').innerHTML = `ğŸ“„ ${file.name} (${(file.size/1024).toFixed(1)}KB)<input type="file" id="fileInput" accept=".txt,.md,.text">`;
            };
            reader.readAsText(file);
        }
        
        async function updateGPU() {
            try {
                const data = await fetch('/api/gpu/status').then(r => r.json());
                const dot = document.getElementById('gpu-dot');
                
                if (data.loading) {
                    dot.className = 'dot loading';
                    document.getElementById('gpu-status').textContent = 'åŠ è½½ä¸­...';
                } else {
                    dot.className = 'dot ' + (data.loaded ? 'on' : 'off');
                    document.getElementById('gpu-status').textContent = data.loaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½';
                }
                
                const usedMB = data.gpu?.used_mb;
                const totalMB = data.gpu?.total_mb;
                if (usedMB !== undefined && totalMB !== undefined) {
                    document.getElementById('gpu-mem').textContent = `${usedMB} / ${totalMB} MB`;
                } else {
                    document.getElementById('gpu-mem').textContent = '-';
                }
                document.getElementById('gpu-idle').textContent = data.idle_seconds !== null && data.idle_seconds !== undefined ? `${data.idle_seconds}ç§’` : '-';
                
                // ç»Ÿä¸€è½¬å¤§å†™åŒ¹é… MODELS key
                const serverModel = data.current_model ? data.current_model.toUpperCase() : null;
                const modelName = serverModel ? (MODELS[serverModel]?.name || serverModel) : '-';
                document.getElementById('gpu-model').textContent = modelName;
                
                // æ›´æ–°æ¨¡å‹å¡ç‰‡çŠ¶æ€ - åŒæ­¥æœåŠ¡å™¨çŠ¶æ€
                if (serverModel !== currentModel) {
                    currentModel = serverModel;
                    renderModelGrid();
                }
            } catch(e) {
                console.error('GPU status error:', e);
            }
        }
        
        let elapsedTimer = null;
        
        async function doTranslate(stream = false) {
            const text = document.getElementById('source').value.trim();
            if (!text) return alert('è¯·è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬');
            
            // å¦‚æœæ²¡æœ‰é€‰ä¸­æ¨¡å‹ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å‹
            const modelToUse = currentModel || defaultModel;
            
            const btn = document.getElementById(stream ? 'stream-btn' : 'translate-btn');
            const otherBtn = document.getElementById(stream ? 'translate-btn' : 'stream-btn');
            btn.disabled = otherBtn.disabled = true;
            btn.textContent = 'ç¿»è¯‘ä¸­...';
            
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressInfo = document.getElementById('progressInfo');
            const streamOutput = document.getElementById('streamOutput');
            const resultArea = document.getElementById('result');
            
            // æ˜¾ç¤ºè¿›åº¦æ¡å’Œè¿›åº¦ä¿¡æ¯
            progressBar.style.display = 'block';
            progressInfo.style.display = 'block';
            progressFill.style.width = '0%';
            streamOutput.style.display = stream ? 'block' : 'none';
            streamOutput.innerHTML = '';
            resultArea.style.display = stream ? 'none' : 'block';
            document.getElementById('stats').style.display = 'none';
            
            // å¯åŠ¨è®¡æ—¶å™¨
            const startTime = Date.now();
            document.getElementById('progress-elapsed').textContent = '0';
            document.getElementById('progress-current').textContent = '0';
            document.getElementById('progress-total').textContent = '-';
            
            elapsedTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('progress-elapsed').textContent = elapsed;
            }, 1000);
            
            if (!stream) document.getElementById('loading').style.display = 'flex';
            
            const body = {
                text,
                target_lang: document.getElementById('target-lang').value,
                source_lang: document.getElementById('source-lang').value || null,
                chunk_size: parseInt(document.getElementById('chunk_size').value),
                overlap: parseInt(document.getElementById('overlap').value),
                max_tokens: parseInt(document.getElementById('max_tokens').value),
                stream,
                model: modelToUse
            };
            
            try {
                if (stream) {
                    const response = await fetch('/api/translate/stream', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(body)
                    });
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let results = [];
                    let totalChunks = 1;
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const lines = decoder.decode(value).split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    if (data.event === 'start') {
                                        totalChunks = data.total_chunks || 1;
                                        document.getElementById('progress-total').textContent = totalChunks;
                                        document.getElementById('stat-input').textContent = data.input_length || text.length;
                                        document.getElementById('stat-chunks').textContent = totalChunks;
                                    } else if (data.event === 'chunk') {
                                        results.push(data.result);
                                        const progress = (data.chunk / data.total * 100);
                                        progressFill.style.width = progress + '%';
                                        document.getElementById('progress-current').textContent = data.chunk;
                                        const div = document.createElement('div');
                                        div.className = 'chunk-item';
                                        div.innerHTML = `<small style="color:#888">ç¬¬${data.chunk}/${data.total}æ®µ (${data.elapsed_ms || '-'}ms)</small><br>${data.result}`;
                                        streamOutput.appendChild(div);
                                        streamOutput.scrollTop = streamOutput.scrollHeight;
                                    } else if (data.event === 'done') {
                                        clearInterval(elapsedTimer);
                                        progressInfo.style.display = 'none';
                                        streamOutput.style.display = 'none';
                                        resultArea.style.display = 'block';
                                        document.getElementById('stat-time').textContent = (data.elapsed_ms || '-') + ' ms';
                                        document.getElementById('stat-output').textContent = data.output_length || 0;
                                        document.getElementById('stat-model').textContent = MODELS[data.model?.toUpperCase()]?.name || data.model || modelToUse;
                                        document.getElementById('stats').style.display = 'block';
                                        // ä½¿ç”¨åç«¯è¿”å›çš„åˆå¹¶ç»“æœ
                                        resultArea.value = data.result || results.join('');
                                        // æ›´æ–°å½“å‰æ¨¡å‹
                                        if (data.model) {
                                            currentModel = data.model.toUpperCase();
                                            renderModelGrid();
                                        }
                                    }
                                } catch(e) {}
                            }
                        }
                    }
                } else {
                    const res = await fetch('/api/translate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(body)
                    });
                    const data = await res.json();
                    
                    clearInterval(elapsedTimer);
                    progressInfo.style.display = 'none';
                    progressBar.style.display = 'none';
                    
                    if (data.status === 'success' || data.result) {
                        resultArea.value = data.result;
                        document.getElementById('stats').style.display = 'block';
                        document.getElementById('stat-time').textContent = (data.elapsed_ms || '-') + ' ms';
                        document.getElementById('stat-input').textContent = data.input_length || text.length;
                        document.getElementById('stat-output').textContent = data.output_length || data.result.length;
                        document.getElementById('stat-chunks').textContent = data.chunks || 1;
                        document.getElementById('stat-model').textContent = MODELS[data.model]?.name || data.model || modelToUse;
                        // æ›´æ–°å½“å‰æ¨¡å‹
                        if (data.model) {
                            currentModel = data.model.toUpperCase();
                            renderModelGrid();
                        }
                    } else {
                        alert('ç¿»è¯‘å¤±è´¥: ' + (data.detail || data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                }
            } catch(e) {
                clearInterval(elapsedTimer);
                alert('è¯·æ±‚å¤±è´¥: ' + e.message);
            } finally {
                clearInterval(elapsedTimer);
                btn.disabled = otherBtn.disabled = false;
                btn.textContent = stream ? 'âš¡ æµå¼' : 'ğŸš€ ç¿»è¯‘';
                document.getElementById('loading').style.display = 'none';
                updateGPU();
            }
        }
        
        function swapLang() {
            const src = document.getElementById('source-lang');
            const tgt = document.getElementById('target-lang');
            if (src.value) [src.value, tgt.value] = [tgt.value, src.value];
            const srcText = document.getElementById('source').value;
            const tgtText = document.getElementById('result').value;
            if (tgtText) {
                document.getElementById('source').value = tgtText;
                document.getElementById('result').value = srcText;
            }
        }
        
        function clearAll() {
            document.getElementById('source').value = '';
            document.getElementById('result').value = '';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('streamOutput').innerHTML = '';
            document.getElementById('streamOutput').style.display = 'none';
            document.getElementById('result').style.display = 'block';
            document.getElementById('progressBar').style.display = 'none';
        }
        
        function copyText(id) {
            const text = document.getElementById(id).value;
            navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶'));
        }
        
        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }
        
        function updateVal(id, val) { document.getElementById(id).textContent = val; }
        
        async function releaseGPU() {
            try {
                await fetch('/api/gpu/offload', {method: 'POST'});
                currentModel = null;
                renderModelGrid();
                updateGPU();
            } catch(e) {
                alert('é‡Šæ”¾å¤±è´¥: ' + e.message);
            }
        }
        
        document.addEventListener('keydown', e => { if (e.ctrlKey && e.key === 'Enter') doTranslate(false); });
        
        init();
    </script>
</body>
</html>
